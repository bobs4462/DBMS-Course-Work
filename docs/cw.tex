\documentclass[14pt,a4paper,russian]{extreport}
%===========================================
\usepackage{geometry} 
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage[russian,english]{babel}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{titlesec}
\usepackage{indentfirst}
\usepackage[hidelinks]{hyperref}
\usepackage{tabularx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{setspace}
%===========================================

%===========================================
\setlength{\parindent}{1.25cm}
\linespread{1.5}
\addto\captionsrussian{\def\bibname{Список использованных источников}}
\geometry{
    a4paper,
    total={170mm,257mm},
    top=20mm,
    right=15mm,
    left=25mm
}

\hypersetup{
    citecolor=black,
    filecolor=black,
    linktoc=all,
}

\titleformat{\chapter}{\normalfont\Large\bfseries\filcenter}{Глава \thechapter}{1em}{}\titlespacing*{\chapter}{0pt}{-43pt}{19pt}

\titleformat{\section}{\normalfont\large\bfseries\filcenter}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\bfseries\filcenter}{\thesubsection}{1em}{}
    
\setlist[itemize]{noitemsep, topsep=0pt}
\setlist[enumerate]{noitemsep, topsep=0pt}

\graphicspath{ {./images/} }

\bibliographystyle{gost71u} 

\let\oldtabularx\tabularx 
\renewcommand{\tabularx}{\small\oldtabularx}

\lstdefinestyle{csql}{
    breaklines=true,
    xleftmargin=\parindent,
    language=SQL,
    showstringspaces=false,
    basicstyle=\linespread{1.3}\footnotesize\ttfamily,
    keywordstyle=\bfseries\color{red},
    identifierstyle=\color{blue},
    stringstyle=\color{cyan},
}
\lstset{extendedchars=\true}
\lstdefinestyle{customc}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  xleftmargin=\parindent,
  language=C,
  showstringspaces=false,
  basicstyle=\footnotesize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
}

\captionsetup[figure]{labelformat=simple, labelsep=space}
\captionsetup[table]{labelformat=simple, labelsep=space, justification=raggedleft, singlelinecheck=false, skip=10pt}
\captionsetup[subtable]{labelformat=empty, labelsep=space, justification=centering, singlelinecheck=false}
\captionsetup[lstlisting]{labelformat=simple, labelsep=space, justification=raggedright, singlelinecheck=false}
%===========================================


\begin{document}

%==============START TITLEPAGE=============
\begin{titlepage}
    \centering
    \begin{figure}
        \center\includegraphics[width=4cm]{stankin.png}
    \end{figure}
    \begin{small}
    \textbf {МИНОБРНАУКИ РОССИИ}\par
    {\textbf{федеральное государственное бюджетное образовательное \\учреждение
    высшего образования\\
     «Московский государственный технологический университет «СТАНКИН»\\
     (ФГБОУ ВО МГТУ «СТАНКИН»)}}\par
\hrulefill\par
     {\textbf{Институт}}\hfill{\textbf{Кафедра\phantom{--00000000000-0--}}}\\
     информационных систем и технологий\hfillинформационных систем\phantom{---0-}\\
    \vspace{1cm} 
    {\textbf {Отчёт по самостоятельной работе}\par}
    {по дисциплине {\textbf{«Управление данными»}}\par}
    на тему: \textbf{Проектирование базы данных поликлиники}
    \vspace{5cm}
    \begin{flushleft}
        {\textbf{Студент}  \hfill \rule{2cm}{0.4pt}\phantom{00}Махмудов Б.Н.\phantom{-0}}\par
        {группа ИДБ-16-07\hfill
        \footnotesize{подпись}\phantom{00000000000000000000000}}\par
        \vspace{1cm}
        {\textbf{Руководитель}\hfill \rule{2cm}{0.4pt}\phantom{00}Быстрикова
        В.А.}\par
        {Старший преподователь\hfill
        \footnotesize{подпись}\phantom{00000000000000000000000}}\par
    \end{flushleft} 
    {\vfill Москва 2018}
    \end{small}
\end{titlepage}
%==============END TITLEPAGE=============

\addtocounter{page}{1}

\selectlanguage{russian}
\begingroup
\onehalfspace
\tableofcontents{}
\endgroup

\newpage

\sloppy

\chapter{Анализ предметной области}

\section{Определение анализа предметной области}
Предметная область — часть реального мира, рассматриваемая в пределах данного контекста. Под
контекстом здесь может пониматься, например, область исследования или область, которая является
объектом некоторой деятельности.\cite{domainknowladge}

Деятельность, направленная на выявление реальных потребностей заказчика, а также на выяснения
смысла высказанных требований, называется анализом предметной области.
Одна из первых задач, с решением которых сталкивается разработчик программной системы - это
изучение, осмысление и анализ предметной области. Дело в том, что предметная область сильно влияет
на все аспекты проекта: требования к системе, взаимодействие с пользователем, модель хранения
данных, реализацию и т.д.  Анализ предметной области, позволяет выделить ее сущности, определить
первоначальные требования к функциональности и определить границы проекта.

Предметной областью данной работы является деятельность поликлиники. Далее следует анализ деятельности
поликлиники, выявление требований к разрабатываемой системе, а также определение функций, которые
данная система должна будет предоставлять пользователям.


\section{Поликлиника: описание предметной области}
Поликлиника — многопрофильное или специализированное лечебно-профилактическое учреждение для
оказания амбулаторной медицинской помощи больным на приёме и на дому.  На территории России
распределены по территориальному признаку, и являются базовым уровнем медицинского обслуживания
населения.  По мощности городские поликлиники делятся на 5 групп. В структуре городской поликлиники
предусматриваются различные подразделения:

\begin{enumerate}[noitemsep]
    \item регистратура,
    \item лечебно-профилактические подразделения,
    \item терапевтические отделения,
    \item отделение восстановительного лечения,
    \item отделения по оказанию специализированных видов медицинской помощи (хирургическое,
        гинекологическое) с кабинетами соответствующих специалистов (кардиологический,
        ревматологический, неврологический, урологический, офтальмологический и т.п.
        
\end{enumerate}

Число отделений и кабинетов, их потенциальные возможности определяются мощностью поликлиники и
количеством штатных должностей, которые зависят от численности закрепленного за
поликлиникой населения. Структура поликлиники (открытие тех или иных отделений, кабинетов и
т. п.) зависит от обращаемости населения в это учреждение, от способности поликлиники предоставить
больным необходимую медицинскую помощь.\cite{medstat}

На сегодняшний день автоматизации подвержено подавляющее большинство сфер деятельности человека,
включая здравохранение. Автоматизация в области здравохранения особенно актуальна ввиду роста человеческого населения
и бюрократизации в сфере оказания медицинских услуг, что приводит к неудобствам и
затруднениям для больных
в получении вышеупомянутых услуг. Разработка информационной системы с
централизованной базой данных, предоставляющая пользователям возможность удалённо получать справки и записываться
на приём к
врачам, позволит уменьшить нагруженность самого учреждения и улучшить качество услуг для
пациентов. Таким образом автоматизация функционирования
поликлиники, в частности разработка базы данных для неё позволит пациентам сэкономить время на
очередях и бюрократических формальностях, а сотрудникам сосредоточиться непосредственно на
оказании медицинских услуг.


\section{Существующие продукты, решающие проблему автоматизации}

\subsection{1С : Медицина. Поликлиника}
Прикладное решение «1С:Медицина. Поликлиника» предназначено для автоматизации основных процессов
медицинских организаций различных организационно-правовых форм, оказывающих медицинскую помощь в
амбулаторно-поликлинических условиях. 

Прикладное решение «1С:Медицина. Поликлиника» позволяет создать единое информационное пространство
медицинской организации с разделением доступа к данным по ролевому принципу. Имеется возможность
вести учет по нескольким медицинским организациям в одной информационной базе.

Программа позволяет вести несколько медицинских карт для одного пациента - амбулаторную карту,
стоматологическую карту и т.д., пример карты пациента приведён на (рис. \ref{fig:pc}). Для каждого медицинского работника указывается, к какому типу карт
он имеет доступ. В программе имеются гибкие механизмы квотирования, которые позволяют устанавливать
ограничения на объемы оказываемой медицинской помощи. Учет деятельности медицинского персонала
ведется по медицинским услугам. Пример пользвательского интерфейса программы показан на
рис. \ref{fig:1c}
\begin{figure}[t!]
        \includegraphics[width=\textwidth]{patientcard}
        \caption{Пример карты пациента}
        \label{fig:pc}
\end{figure}
\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{1cinterface}
        \caption{Пользовательский интерфейс «1С:Медицина. Поликлиника»}
        \label{fig:1c}
\end{figure}

Предварительную запись пациентов может осуществлять как регистратура, так и врачи при выполнении
назначений повторных приемов, консультаций, исследований, манипуляций. Для осуществления
оперативного планирования врачебному медицинскому персоналу и кабинетам задаются графики работы,
нормы загрузки, перечень выполняемых услуг. Оперативное планирование деятельности кабинетов
осуществляется по данным предварительной записи пациентов.\cite{1cclinic}
Можно выделить основные функциональные возможности «1С:Медицина. Поликлиника»:
\begin{enumerate}[noitemsep]
    \item Регистратура
    \item Листки нетрудоспособности (больничные)
    \item Договорной отдел
    \item Контроль исполнения медицинских услуг персоналом
    \item Руководитель и аналитическая (статистическая) служба
    \item Электронные медицинские карты
    \item Профосмотры
    \item Интернет запись на прием и обмен данными с сайтами
\end{enumerate}

\subsection{Сайт частных поликлиник «СМ-Клиника»}
Многопрофильный медицинский холдинг «СМ-Клиника»  - это сеть многопрофильных
медицинских центров для взрослых и детей, основанной в 2002 году. Услуги поликлиник предоставляются
на коммерческой основе.
Сайт компании доступен по адресу «http://www.smclinic.ru/».
Скриншот главной страницы сайта приведён на рис. \ref{fig:cc}.
На главной странице сайта можно выделить следующие функции:
\begin{itemize}[noitemsep]
    \item записаться на приём,
    \item личный кабинет, 
    \item услуги,
    \item анализы и диагностика.
\end{itemize}


\begin{figure}[t!]
        \includegraphics[width=\textwidth]{cmclinic}
        \caption{Главная страница сайта «СМ-Клиника»}
        \label{fig:cc}
\end{figure}

Функция «Записаться на приём» позволяет предварительно записаться на приём к лечащему врачу посредством заполнения
со стороны пользователя соответствующей формы (рис. \ref{fig:appdoc}).

\begin{figure}[t!]
        \includegraphics[width=\textwidth]{appdoc}
        \caption{Форма записи на приём к врачу в «СМ-Клиника»}
        \label{fig:appdoc}
\end{figure}
\begin{figure}[t!]
        \includegraphics[width=\textwidth]{lkcm}
        \caption{Страница с перечнем предостваляемых услуг}
        \label{fig:lkcm}
\end{figure}

Функция «Личный кабинет» предоставляет широкий перечень возможностей для зарегистрированных
пользователей:

\begin{itemize}[noitemsep]
\renewcommand\labelitemi{--}
    \item Получить доступ к своей медицинской карте - увидеть детальную историю всех посещений
        клиники, фамилии лечащих докторов, их специализации, точные даты посещений и другую
        полезную информацию;

    \item посмотреть назначенную схему лечения, рекомендации лечащих врачей, назначенные
        обследования и др.;

    \item ознакомиться с результатами анализов и обследований, сохранить их на локальный компьютер или
        сразу распечатать;

    \item увидеть, когда лечащий врач пациента работает и какое время для приема на текущий момент у него
        свободно;

    \item самостоятельно записаться к врачу в удобное для пользователя время;

    \item посмотреть текущую скидку пользователя, актуальные акции и предложения клиник;

    \item оставить отзыв о враче или клинике.\cite{smclin}

\end{itemize}
Функция «Услуги» позволяет подробно ознакомится c перечнем услуг предостваляемых поликлиникой
(рис. \ref{fig:lkcm}).


\subsection{Сравнение «1С:Медицина. Поликлиника» и сайта поликлиники «СМ-Клиника»}
Оба рассмотренных продукта, хотя и ориентированы на разные категории пользователей, имеют перечень
общих функций:
\begin{itemize}[noitemsep]
\renewcommand\labelitemi{--}
    \item доступ к электронной медицинской карте,
    \item запись на прием к врачу,
    \item ознакомиться с графиком лечащего врача,
    \item доступ к перечню предоставляемых поликлиникой услуг.
\end{itemize}

В рамках данной работы планируется создание единой платформы для
взамодейстивия пациентов с сотрудниками поликлиники. Проанализировав программные продукты решающие
схожие задачи в данной предметной области, можно выделить ряд функций, которые необходимо
реализовать в процессе разработки:
\begin{itemize}[noitemsep]
		
\renewcommand\labelitemi{--}
            \item Просмотр и/или редактирование медицинских карт,
            \item просмотр и/или редактирование результатов анализов,
            \item запись на приём к врачу,
            \item проcмотр и/или редактирование записей к врачам,
            \item создание листков нетрудоспособности,
            \item просмотр и/или редактирование результатов профосмотров,
            \item поиск всей информации касательно пациента,
            \item доступ к графику работы врачей;
\end{itemize}


\chapter{Концептуальное проектирование}
\section{Определение концептуального проектирования}
Концептуальное проектирование — построение семантической модели предметной
области, то есть информационной модели наиболее высокого уровня абстракции. Такая модель создаётся
без ориентации на какую-либо конкретную СУБД и модель данных.
Чаще всего концептуальная модель базы данных включает в себя описание информационных объектов 
или понятий предметной области и связей между ними. Для визуализации концептуальной
модели часто используется диаграмма вариантов использования.\par
Диаграмма вариантов использования (ДВИ) — диаграмма, отражающая
отношения между действующими лицами и вариантами использования разрабатываемой системы, и
позволяющей описать систему на концептуальном уровне.
Основное назначение диаграммы — описание функциональности и поведения, позволяющее заказчику,
конечному пользователю и разработчику совместно обсуждать проектируемую или существующую
систему.\par

Действующее лицо - внешняя по отношению к ИС сущность, которая может
взаимодействовать с системой. Действующим лицом могут быть как люди, так и внешние системы или
устройства.\par
Вариант использования — возможность моделируемой системы (часть её функциональности), благодаря которой
пользователь может получить конкретный, измеримый и нужный ему результат. \cite{dbdesign}


\section{Концептуальная модель базы данных поликлиники}
В завершении анализа предметной области был выделен перечень функций, которые необходимо реализовать
в рамках данной работы, и рассматривая данную ИС с точки зрения возможных вариантов использования, можно 
разделить эти функции между действующими лицами.\par
\noindent Действующими лицами разрабатываемой системы являются:
\begin{enumerate}[noitemsep]
    \item сотрудник регистратуры,
    \item врач,
    \item пациент.    
\end{enumerate}


Далее приведены варианты использования для каждого из действующих лиц. Сама же диаграмма показана на
рис. \ref{fig:ClinicDB}.
\begin{itemize}[noitemsep]
    \item Сотрудник регистратуры может выполнять в системе следующие действия:
        \begin{enumerate}[noitemsep]
            \item поиск по медицинским картам пациентов,
            \item выдача информации по графику работы врачей,
            \item создание медицинской карты пациента,
            \item запись пациента к врачу.
        \end{enumerate}
    \item Врач может выполнять в системе следующие действия:
        \begin{enumerate}[noitemsep]
            \item промотр истории болезней пациента.
            \item назначение лечения,
            \item назначение анализов,
            \item выписка рецептов пациентам,
            \item выписка листков нетрудоспособности.
        \end{enumerate}
    \item Пациент может выполнять в системе следующие действия:
        \begin{enumerate}[noitemsep]
            \item ознакомление с графиком работы врачей,
            \item запись на приём к врачу,
            \item просмотр личной медицинской карты,
        \end{enumerate}
\end{itemize}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{ClinicDB}
        \caption{Диаграмма вариантов использования}
        \label{fig:ClinicDB}
\end{figure}

Приняв во внимание всё вышесказанное, можно выделить данные, которые необходимо хранить в проектируемой базе данных:
\begin{itemize}[noitemsep]
\renewcommand\labelitemi{--}
    \item информация о пациентах,
    \item информация о сотрудниках поликлиники,
    \item информация о медицинских картах, т.е. их цифровые копии,
    \item информация о графике приема пациентов врачами,
    \item информация о записях пациентов,
    \item информация об анализах,
    \item информация о выписанных рецептах,
    \item информация о выданных листках нетрудоспособности,
    \item информация о назначенных лечениях.
\end{itemize}

Перечисленные данные можно подразделить на две группы:
\begin{itemize}[noitemsep]
    \item условно-постоянные(данные пациентов, сотрудников),
    \item оперативно-обновляемые(медицинские карты, график приема пациентов врачами, информация об
        анализах и т.д.).
\end{itemize}


\chapter{Логическое проектирование}
\section{Определение логического проектирования}
Логическое проектирование — создание схемы базы данных на основе конкретной модели
данных, например, реляционной модели данных. Для реляционной модели данных, логическая модель это
набор схем отношений, обычно с указанием первичных ключей, а также «связей»
между отношениями, представляющих собой внешние ключи. Логическая модель
описывает понятия предметной области, их взаимосвязь, а также ограничения на
данные, налагаемые предметной областью.

Опираясь на концептуальную модель, проектируется логическая модель. Часто для выполнения этой
задачи используются различные модели данных, например ER-модель.
На этапе логического проектирования учитывается специфика конкретной модели данных, но может
не учитываться специфика конкретной СУБД. 

ER-модель (от англ. entity-relationship model, модель «сущность — связь») — модель данных,
позволяющая описывать концептуальные схемы предметной области.  ER-модель используется при
высокоуровневом (концептуальном) проектировании баз данных. С её помощью можно выделить ключевые
сущности и обозначить связи, которые могут устанавливаться между этими сущностями.\cite{dbdesign}


\vspace{0.7cm}
\section{ER-модель базы данных поликлиники}
На основе концептуальной модели поликлиники, описанной в конце предыдущей главы, можно
спроектировать ER-модель данной предметной области, и представить полученую модель с
помощью стандартной графической нотации ER-диаграммы (диаграммы сущность-связь).
\cleardoublepage
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{patappemp}
        \caption{Запись пациента к сотруднику (врачу)}
        \label{fig:patappemp}
\end{figure}

Тип связи ``Запись'' (рис. \ref{fig:patappemp}) - M:N.
Класс принадлежности необязательный для обоих экземпляров сущностей.
Пациент может записаться к нулю или более сотрудникам (врачам), сотрудник может принять ноль или более
пациентов. 

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{medcvisemp}
        \caption{Посещения врача пациентом по медкарте}
        \label{fig:medcvisemp}
\end{figure}

Тип связи ``Посещения'' (рис. \ref{fig:medcvisemp}) - M:N.
Класс принадлежности необязательный для обоих экземпляров сущностей.
Сотрудник может принимать нуль или более пациентов по медкарте, медкарта может
содержать информацию о нуль или более посещениях пациента.

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{medcbelpat}
        \caption{Принадлежность медицинской карты пациенту}
        \label{fig:medcbelpat}
\end{figure}

Тип связи ``Владеет'' (рис. \ref{fig:medcbelpat}) - 1:M.
Класс принадлежности обязательный для обоих экземпляров сущностей.
Пациент может владеть одной или более медкартами, медкарта должна принадлежать
только одному пациенту.
\cleardoublepage

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{cardan}
        \caption{Назначение анализов пациенту по медкарте}
        \label{fig:cardan}
\end{figure}
Тип связи ``Назначает'' (рис. \ref{fig:cardan}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Анализ.
Сотрудник может назначить нуль или более анализов, анализ может
быть назначен только одним сотрудником.

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{newcardan}
        \caption{Назначение анализов пациенту по медкарте}
        \label{fig:newcardan}
\end{figure}

Тип связи ``Вноситься'' (рис. \ref{fig:newcardan}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Анализ.
Анализ может быть сдан ровно одним пациентом по медкарте, по
медкарте пациент может сдать нуль или более анализов

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{empcure}
        \caption{Назначение лечения врачом}
        \label{fig:empcure}
\end{figure}
Тип связи ``Предписывает'' (рис. \ref{fig:empcure}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Лечение.
Лечение может быть предписано ровно в одним сотрудником, сотрудник
может предписать нуль или более лечений.

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{medcure}
        \caption{Внесение записи о лечении в медицинскую карту}
        \label{fig:medcure}
\end{figure}
Тип связи ``Вносится в'' (рис. \ref{fig:medcure}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Лечение.
Лечение может быть внесено ровно в одну медкарту, в медкарту можно
внеси нуль или более лечений.

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{receipt}
        \caption{Выписывание врачом рецепта пациенту}
        \label{fig:receipt}
\end{figure}

Тип связи ``Выписывает'' (рис. \ref{fig:receipt}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Рецепт.
Врач может выписать нуль или более рецептов,
рецепт может быть выписан ровно одним врачом.\par

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{empbolpat}
        \caption{Выдача больничного пациенту}
        \label{fig:empbolpat}
\end{figure}

Тип связи ``Выдаётся'' (рис. \ref{fig:empbolpat}) - 1:M.
Класс принадлежности обязательный только для экземпляра сущности Больничный.
Больничный (как документ) может быть выдан ровно одному пациенту,
пациент может получить нуль или более больничных.

\begin{figure}[h!]
        \includegraphics[width=\textwidth]{timetable}
        \caption{График работы сотрудников}
        \label{fig:timetable}
\end{figure}

Тип связи ``Работает по'' (рис. \ref{fig:timetable}) - M:N.
Класс принадлежности обязательный для экземпляра сущности Сотрудник.
Сотрудник может работать более одного дня в неделю, в один день
могут работать нуль или более сотрудников.

\section{Преобразование ER-модели в реляционную}
\begin{enumerate}[noitemsep]
\renewcommand\labelitemi{--}
    \item Связь ``Запись'' удовлетворяет условиям правила 6, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Пациент(\underline{Регистрационный номер}, ...);
            \item Сотрудник(\underline{Табельный номер}, ...);
            \item Запись(\underline{Табельный номер, Регистрационный номер}, ...).
        \end{itemize}
    \item Связь ``Посещения'' удовлетворяет условиям правила 6, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Медкарта(\underline{Номер медкарты}, Регистрационный номер, ...);
            \item Сотрудник(\underline{Табельный номер}, ...);
	    \item Посещения(\underline{Номер посещения}, Табельный номер, Номер медкарты, ...).
        \end{itemize}

    \item Связь ``Владеет'' удовлетворяет условиям правила 4, откуда получаются следующие таблицы
    \begin{itemize}[noitemsep]
            \item Пациент(\underline{Регистрационный номер}, ...);
            \item Медкарта(\underline{Номер медкарты}, Регистрационный номер, ...).
        \end{itemize}
    \item Связь ``Назначает'' удовлетворяет условиям правила 4, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Сотрудник(\underline{Табельный номер}, ...);
            \item Анализ(\underline{Номер анализа}, Табельный номер, ...).
        \end{itemize}
    \item Связь ``Вносится'' удовлетворяет условиям правила 4, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Медкарта(\underline{Номер медкарты}, ...);
            \item Анализ(\underline{Номер анализа}, номер медкарты, ...).
        \end{itemize}
\item Связь ``Предписывает'' удовлетворяет условиям правила 4, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Сотрудник(\underline{Табельный номер}, ...);
	    \item Лечение(\underline{Номер лечения}, Табельный номер, ...).
        \end{itemize}
\item Связь ``Вносится в'' удовлетворяет условиям правила 4, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Медкарта(\underline{Номер медкарты}, ...);
	    \item Лечение(\underline{Номер лечения}, Номер медкарты, ...).
        \end{itemize}
\item Связь ``Рецепт'' удовлетворяет условиям правила 4, откуда получаются следующие таблицы
    \begin{itemize}[noitemsep]
            \item Сотрудник(\underline{Табельный номер}, ...);
            \item Рецепт(\underline{Номер рецепта}, Табельный номер, ...).
        \end{itemize}
    \item Связь ``Выдаётся'' удовлетворяет условиям правила 4, откуда получаются следующие
        таблицы
	\begin{itemize}[noitemsep]
            \item Пациент(\underline{Регистрационный номер}, ...);
	    \item Больничный(\underline{Номер больничного}, Регистрационный номер, ...).
        \end{itemize}
    \item Связь ``Работает по'' удовлетворяет условиям правила 6, но так как сущность «День недели» имеет только один атрибут, то в результате получаются две таблицы, с миграцией первичного ключа сущности «День недели» в дочернее отношение.
	\begin{itemize}[noitemsep]
            \item Сотрудник(\underline{Табельный номер}, ...);
            \item График(\underline{День недели, Табельный номер}, ...).
        \end{itemize}
\end{enumerate}
В итоге получается десять таблиц, которые приведены ниже с перечнем всех относящихся к ним атрибутам.
\begin{enumerate}[noitemsep]
            \item Пациент(\underline{Регистрационный номер}, ФИО, страховая компания, договор страхования, дата рождения, пол, адрес
                проживания, контактный телефон, пароль от ЛК);
            \item Сотрудник(\underline{Табельный номер}, ФИО, должность, стаж, дата рождения, пол, адрес
                проживания, контактный телефон, пароль от ЛК);
            \item Запись(\underline{Табельный номер, Регистрационный номер}, дата и время записи);
	    \item Посещения(\underline{Номер посещения}, Табельный номер, Номер медкарты, дата посещения,
                цель визита);
            \item Медкарта(\underline{Номер медкарты}, Регистрационный номер, дата заведения, тип);
	    \item Анализ(\underline{Номер анализа}, Табельный номер, Номер медкарты, дата сдачи, вид анализа,
                результат);
	\item Лечение(\underline{Номер лечения}, Табельный номер, номер медкарты, дата назначения,
                заболевание, назначенное лечение);
            \item Рецепт(\underline{Номер рецепта}, Табельный номер, дата выписки, медикаменты);
            \item Больничный(\underline{Номер больничного}, Регистрационный номер, дата выдачи,
                начало больничного,окончание больничного, место работы/обучения);
            \item График(\underline{День недели, Табельный номер}, начало смены, конец смены,
                перерыв).
\end{enumerate}



\chapter{Физическое проектирование}
Физическое проектирование — создание схемы базы данных для конкретной СУБД. Специфика конкретной
СУБД может включать в себя ограничения на именование объектов базы данных, ограничения на
поддерживаемые типы данных и т. п. Кроме того, специфика конкретной СУБД при физическом
проектировании включает выбор решений, связанных с физической средой хранения данных (выбор методов
управления дисковой памятью, разделение БД по файлам и устройствам, методов доступа к данным),
создание индексов и т. д.\cite{dbdesign} 


\section{Выбор СУБД}
В данной работе для реализации базы данных поликлиники была выбрана реляционная СУБД
SQLite. Такой выбор обоснован спецификой предметной области, а именно относительно небольшим
объёмом хранимых данных и средней частотой обращения к базе данных. SQLite является
встраиваемой, т.е. вместо использования привычной парадигмы клиент-сервер, SQLite представляет из
себя библиотеку с интерфейсами для многих языков программирования. Этот факт делает SQLite
чрезвычайно компактным и быстрым, т.к. СУБД встраиваится напрямую в разрабатываемое приложение.
Несмотря на свою простоту данная СУБД может обслуживать базы данных размером до 140 террабайт и
поддерживает параллельный доступ к БД несколькими процессами. \cite{sqlite}


\section{Схема БД поликлиники}
На основании ER-модели, полученной в конце предыдущей главы, где были описаны таблицы и их атрибуты,
далее приведены окончательные структуры таблиц (табл. 4.1 - 4.12), созданных в СУБД SQLite. Поля перечислены в
том же порядке, который был описан ранее. SQL операторы
использованные для создания таблиц приведены в конце текущей главы, в приложении А приведены примеры их
заполнения.


\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Сотрудник»}}
    \begin{tabularx}{\textwidth}{| X | X | X | c | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        tabid & integer & not null & первичный & & &  \\ \hline
        fio & text & not null & & & & \\ \hline
        position & text & not null & & & & \\ \hline
        experien & integer & not null & & 0 & < 100 & \\ \hline
        birthdate & date & not null & & & < date('now') & \\ \hline
        gender & char(1) & not null & & & `М' или `Ж' & \\ \hline
        address & text & & & & & \\ \hline
        pnumber & text & & & & & \\ \hline
        password & text & not null & & abs(random()) & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:emp}
\end{table}

\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Пациент»}}
    \begin{tabularx}{\textwidth}{| X | X | X | c | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        regid & integer & not null & первичный & & & \\ \hline
        fio & text & not null & & & & \\ \hline
	insurcomp & text & & & & & \\ \hline
	icontract & text  & & & & & \\ \hline
        birthdate & date & not null & & & < date('now') & \\ \hline
        gender & char(1) & not null & & & `М' или `Ж' & \\ \hline
        address & text & & & & & \\ \hline
        pnumber & text & & & & & \\ \hline
        password & text & not null & & abs(random()) & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:pat}
\end{table}

\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Запись»}}
    \begin{tabularx}{\textwidth}{| X | X | X | X | X | X | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        tabid & integer & not null & первичный, внешний & & & Сотрудник (tabid) \\ \hline
        regid & integer & not null & первичный, внешний & & & Пациент (regid)  \\ \hline
        recdatetime & datetime & not null & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:rec}
\end{table}

\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Медкарта»}}
    \begin{tabularx}{\textwidth}{| X | X | c | c | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        cardid & integer & not null & первичный & & & \\ \hline
        regid & integer & not null & внешний & & & Пациент (regid) \\ \hline
        crdate & date & not null & & date('now') & & \\ \hline
        type & text & & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:medcard}
\end{table}


\begin{table}[h!]
    \caption{ }
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Посещения»}}
    \begin{tabularx}{\textwidth}{| X | X | c | X | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
            visid & integer & not null & первичный & & & \\ \hline
            tabid & integer & not null & внешний & & & Сотрудник (tabid) \\ \hline
            cardid & integer & not null & внешний & & & Медкарта (cardid)\\ \hline
            visdate & date & not null &  & date('now') & & \\ \hline
            visgoal & text & not null & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:visit}
\end{table}

\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Рецепт»}}
    \begin{tabularx}{\textwidth}{| X | X | c | X | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
	    receiptid & integer & not null & первичный & & & \\ \hline
            tabid & integer & not null & внешний & & & Сотрудник (tabid) \\ \hline
            issuedate & date & not null & & date('now') & & \\ \hline
        medicine & text & not null & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:receipt}
\end{table}

\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «График»}}
    \begin{tabularx}{\textwidth}{| X | X | X | X | X | X | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        weekday & text & not null & первичный & & & \\ \hline
        tabid & integer & not null & первичный, внешний & & & Сотрудник (tabid) \\ \hline
        shiftst & integer & not null & & & & \\ \hline
        shiftend & integer & not null & & & & \\ \hline
        break & integer & not null & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:timetable}
\end{table}


\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Лечение»}}
    \begin{tabularx}{\textwidth}{| X | X | c | X | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        treatid & integer & not null & первичный & & & \\ \hline
        tabid & integer & not null &  внешний & & & Сотрудник (tabid) \\ \hline
        cardid & integer & not null &  внешний & & & Медкарта (cardid) \\ \hline
        trdate & date & not null & первичный & date('now') & & \\ \hline 
        illness & text & & & & & \\ \hline
        treatment & text & & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:treat}
\end{table}


\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Больничный»}}
    \begin{tabularx}{\textwidth}{| X | X | c | X | c | X | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
            sickid & integer & not null & первичный & & & \\ \hline
            regid & integer & not null & внешний & & & Пациент (regid)\\ \hline
            issuedate & date & not null & & date('now') & & \\ \hline
        stdate & date & not null & & & & \\ \hline
        endate & date & not null & & & endate > stdate & \\ \hline
        destn & text & not null & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:sickleave}
\end{table}




\begin{table}[h!]
    \caption{ } 
    \begin{subtable}[t]{\textwidth}
        \caption{\textbf{Структура таблицы «Анализ»}}
    \begin{tabularx}{\textwidth}{| X | X | c | c | c | c | X |}
        \hline
        \textbf{Столбец} & \textbf{Тип данных} & \textbf{Нуль?} & \textbf{Ключ} & \textbf{По
        умолч.} & \textbf{Огранич.} & \textbf{Ссылка} \\ \hline
        anid & integer & not null & первичный & & & \\ \hline
        tabid & integer & not null & внешний & & & Сотрудник (tabid) \\ \hline
        cardid & integer & not null & внешний & & & Медкарта (cardid) \\ \hline
        passdate & date & not null & & date('now') & & \\ \hline
        type & text & not null & & & & \\ \hline
        result & text & & & & & \\ \hline
    \end{tabularx}
    \end{subtable}
    \label{table:analysis}
\end{table}





\vfill
Таблица «Сотрудник» содержит информацию о сотрудниках поликлиники (см. табл. \ref{table:emp}).\par
Таблица «Пациент» содержит персональные данные и контактную информацию пациентов поликлиники (см. табл.
\ref{table:pat})\par
Таблица «Запись» содержит информацию о записях пациентов к врачам поликлиники,
дополнительные ограничения на таблицу это требования уникальности табельного номера врача и времени
записи unique(tabid, recdatetime), а также уникальность регистрационного номера пациента и времени
записи unique(regid, recdatetime) (см. табл. \ref{table:rec}).\par
Таблица «Медкарта» содержит информацию о медкартах пациентов, также на таблицу наложены дополнительные ограничения, такие как
требования уникальности регистрационного номера пациента и типа медкарты unique(regid, type) (см. табл.
\ref{table:medcard}).\par
Таблица «Посещения» содержит информацию о факте посещения врача пациентом (см. табл.
\ref{table:visit}).\par
Таблица «Рецепт» содержит информацию о рецептах выписанных врачами пациентам (см. табл.
\ref{table:receipt}).\par
Таблица «График» содержит информацию о графиках сотрудников.
(см. табл. \ref{table:timetable}).\par
Таблица «Лечение» содержит информацию о лечениях назначаемых врачами пациентам (см. табл.
\ref{table:treat}).\par
Таблица «Больничный» содержит информацию о листках нетрудоспособности выданных врачами пациентам
(см. табл. \ref{table:sickleave}).\par
Таблица «Анализ» содержит информацию об анализах назначенных врачамм пациентам поликлиники (см.
табл. \ref{table:analysis}).\par


На рис. clinic\ref{fig:clinic} можно ознакомиться с общей схемой базы данных созданной в СУБД SQLite. Визуализаация схемы была
произведена средствами программного продукта DataGrip версия 2017.2.

\begin{figure}[t!]
        \includegraphics[width=\textwidth]{clinic}
        \caption{Схема базы данных поликлиники}
        \label{fig:clinic}
\end{figure}
\vfill
\phantom{0}

\section{SQL операторы создания таблиц}
\setcounter{lstlisting}{0}


\lstinputlisting[title=1. Создание таблицы «Пациент», label=list:cpat, style=csql]{code/cpatient.sql}
\lstinputlisting[title=2. Создание таблицы «Сотрудник», label=list:cemp, style=csql]{code/cemployee.sql}
\lstinputlisting[title=3. Создание таблицы «Запись», label=list:rec, style=csql]{code/cappointment.sql}
\newpage
\lstinputlisting[title=4. Создание таблицы «Больничный», label=list:reserv, style=csql]{code/csickleave.sql}
\lstinputlisting[title=5. Создание таблицы «График», label=list:timetable, style=csql]{code/ctimetable.sql}
\lstinputlisting[title=6. Создание таблицы «Анализ», label=list:res, style=csql]{code/canalysis.sql}
\lstinputlisting[title=7. Создание таблицы «Лечение», label=list:treat, style=csql]{code/ctreatment.sql}
\newpage
\lstinputlisting[title=8. Создание таблицы «Медкарта», label=list:medc, style=csql]{code/cmedcard.sql}
\lstinputlisting[title=9. Создание таблицы «Посещения», label=list:visit, style=csql]{code/cvisit.sql}
\lstinputlisting[title=10. Создание таблицы «Рецепт», label=list:serv, style=csql]{code/creceipt.sql}

\section{Индексы, представления, триггеры, созданные для решеня задач БД}
\lstinputlisting[title=11. Индексы таблицы «Запись», label=list:idxapp, style=csql]{code/idx-appointment.sql}
\lstinputlisting[title=12. Индексы таблицы «Медкарта», label=list:idxmedc, style=csql]{code/idx-medcard.sql}
\lstinputlisting[title=13. Представление «medicalcard» собирающее данные из таблиц «Анализ» «Посещения» «Лечение» «Сотрудник» по фильтру - идентификатор медкарты, label=list:viewmedicalcard, style=csql]{code/view-medicalcard.sql}
\lstinputlisting[title=14. Представление «patient\_info» собирающее данные из таблицы «Пациент» по фильтру - идентификатор пациента с переименованием полей, label=list:viewpatientinfo, style=csql]{code/view-patient-info.sql}
\lstinputlisting[title=15. Представление «patient\_medcard» собирающее данные из таблиц «Пациент» «Медкарта» и из представления «medicalcard» по фильтру идентификатор пациента, label=list:viewpatientmedcard, style=csql]{code/view-patient-medcard.sql}
\lstinputlisting[title=16. Триггер «insert\_visit» срабатывающий после вставки в таблицу «Посещения» и удаляющий запись пациента к врачу, label=list:triginsertvisit, style=csql]{code/trig-insert-visit.sql}
\lstinputlisting[title=17. Триггер «insert\_treatment» срабатывающий после вставки в таблицу «Лечение» и удаляющий запись пациента к врачу, label=list:triginserttreatment, style=csql]{code/trig-insert-treatment.sql}
\lstinputlisting[title=18. Триггер «insert\_analysis» срабатывающий после вставки в таблицу «Анализ» и удаляющий запись пациента к врачу, label=list:triginsertanalysis, style=csql]{code/trig-insert-analysis.sql}
\lstinputlisting[title=19. Триггер «archive\_card» срабатывающий при попытке удаления записи из таблицы «Медкарта» и архивирующий карту, label=list:trigarchivecard, style=csql]{code/trig-archive-card.sql}
\lstinputlisting[title=20. Триггер «archive\_patient» срабатывающий при попытке удаления записи из таблицы «Пациент» и архивирующий пациента, label=list:trigarchivepatient, style=csql]{code/trig-archive-patient.sql}

\chapter{Описание функционирования БД}
\section{Назначение и перечень функций базы данных}
Далее приведены функции, которые предоставляет, реализованный в данной работе программный продукт, пользователям для работы с базой данных.
\begin{enumerate}
	\item Поиск по пациентам, используя часть имени пациента в качестве критерия поиска;
	\item Получение доступа к списку врачей с целью:
		\begin{itemize}
				\renewcommand\labelitemi{--}
			\item ознакомления с расписанием выбранного врача,
			\item запись на прием к выбранному врачу.
		\end{itemize}
	\item Просмотр перечня карт выбранного пациента, и дальнейшее ознакомление с содержимым отдельно взятой карты;
	\item Просмотр рецептов выписанных пациенту;
	\item Просмотр листов нетрудоспособности выданных конкретному пациенту;
	\item Назначение лечения пациенту c занесением в медицинскую карту;
	\item Назначение сдачи анализов пациенту с занесением факта назначения и результа анализа в медицинскую карту;
	\item Выписка рецепта пациенту;
	\item Выдача листа нетрудоспособности пациенту;
	\item Создание нового пациента в базе данных;
	\item Создание новой медицинской карты выбранному пациента;
	\item Удаление пациента из базы активных пациентов, с последующим перемещение всех его данных в архив;
	\item Получение доступа к архиву пациентов.
\end{enumerate}
\cleardoublepage
Ограничение доступа к какой-либо отдельно взятой функции, осуществляется на стороне клиентского приложения, в зависимости от роли пользователя (пациент, врач, сотрудник регистратуры).

\section{Описание работы с базой данных}
\subsection{Вход в систему}
При попытке входа в систему (рис. \ref{fig:login}), программа определяет тип пользоваетеля и делает запрос в базу данных к соответсвующей таблице. В зависимости от ответа базы данных, программа либо запускает необходимый интерфейс пользоваетеля, либо выдает сообщение о неправильности введённых данных.
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/login-screen}
        \caption{Окно входа в систему}
        \label{fig:login}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие 
\begin{lstlisting}[style=csql] 
1. SELECT * FROM patient where regid = ? AND password = ?
2. SELECT * FROM employee where tabid = ? AND password = ?
\end{lstlisting}
\noindentЗдесь и далее символ «?» используется для обозначения мест в sql запросах, куда будут подставлены параметры.
Выбор первого или второго запроса совершает клиентское приложение, в зависимости от введённых пользоваетелем данных.
Если запрос вернёт кортеж, то такой пользоваетель существуют в базе, и программа открывает для него соответсвующий интерфейс.

\subsection{Интерфейс пациента}
Интерфейс пациента приведен на рис. \ref{fig:patientint}, перечень доступных функций виден на рисунке в правом окне, в левом окне отображена личная информация пользователя.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/patient-interface}
        \caption{Окно интерфейса пользоваетеля}
        \label{fig:patientint}
\end{figure}
Для заполнения данных о пациенте используется следующий запрос:
\begin{lstlisting}[style=csql] 
SELECT * from patient_info where regid = ?
\end{lstlisting}
\noindentЗапрос обращается к представлению «patient\_info» (листинг \ref{list:viewpatientinfo}) для получения данных.\par\par

Функция записи к врачу (рис. \ref{fig:appointment1}) состоит из трёх этапов: выбор врача, выбор даты (доступны ближайшие семь дней), выбор времени приёма.
Если врач имеет выходные в ближайшие семь дней, то эти даты не доступны для выбора (рис. \ref{fig:appointment2}). Также присутствует проверка доступности времени приёма, таким образом из спиcка (рис. \ref{fig:appointment3}) удаляются время перерыва врача, и то время на которое уже существуют записи.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/appointment1}
        \caption{Запись. Этап выбора врача}
        \label{fig:appointment1}
\end{figure}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/appointment2}
        \caption{Запись. Этап выбора даты}
        \label{fig:appointment2}
\end{figure}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/appointment3}
        \caption{Запись. Этап выбора времени приёма}
        \label{fig:appointment3}
\end{figure}
\newpage
\noindentЗапросы, которые отправляются в базу данных следующие:
\begin{lstlisting}[style=csql] 
1. SELECT vacant_time(?, ?)
2. INSERT INTO appointment values(?, ?, ?)
3. SELECT e.fio, a.recdatetime, a.tabid FROM appointment a 
   INNER JOIN employee e ON a.tabid = e.tabid 
   WHERE (a.regid = ? AND a.tabid = ?) OR (a.regid = ? AND a.recdatetime = ?)
\end{lstlisting}
\noindentПервый запрос использует пользовательскую функцию для получения всего свободного времени которое доступно у выбранного врача.
Второй запрос используется для вставки записи в таблицу «Запись».
Третий запрос срабатывает в том случае если пациент уже имеет запись к какому либо врачу и выбирает то же время к другому врачу, тем самым вызывая нарушение целостности. Запрос уведомляет пользователя что пациент уже имеет запись на данное время.\par\par

Функция просмотра записей пациента рис. \ref{fig:appointments-show}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/appointments-show}
        \caption{Список записей пациента}
        \label{fig:appointments-show}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие:
\begin{lstlisting}[style=csql] 
1. SELECT a.recdatetime, e.fio, e.position FROM appointment a
   JOIN employee e on a.tabid = e.tabid WHERE regid = ? 
\end{lstlisting}
\noindentДанный запрос возвращает список всех записей, которые на данный момент существуют у пациента в виде ФИО врача, должность врача и время записи.\par\par

Функция просмотра рецептов, выписанных пациенту. Пользоветелю представляется возможности выбрать из списка всех рецептов, после чего программа отображает форму рецепта рис. \ref{fig:receipt-form}.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/receipt}
        \caption{Форма рецепта, выписанного пациенту}
        \label{fig:receipt-form}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. SELECT r.receiptid, r.medicine, r.issuedate, e.fio, p.fio, 
	  CAST ((julianday('now') - julianday(p.birthdate)) / 365.25 as INTEGER), 
	  p.address FROM 
	  receipt r JOIN employee e ON e.tabid = r.tabid JOIN 
	  patient p ON p.regid = r.regid where r.regid = ?
\end{lstlisting}
\noindentЗапрос возвращает всю необходимую информацию, для заполнения формы рецепта №148-1/у-88.\par\par

Функция просмотра расписание врачей. Пользоветелю представляется возможности выбрать нужного врача из списка, после чего программа отображает расписание выбранного врача (начало смены, конец смены, начало перерыва) рис. \ref{fig:timetable-show}.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/timetable}
        \caption{Расписание выбранного врача}
        \label{fig:timetable-show}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. SELECT weekday, get_time(shiftst), get_time(shiftend), get_time(break)
   FROM timetable where tabid = ? and shiftst IS NOT NULL ORDER BY daynum
\end{lstlisting}
\noindentЗапрос использует пользовательскую функцию get\_time для конвертирования числового представления времени в формат ЧАСЫ:МИНУТЫ, и возвращает расписание врача, исключив из него выходные дни.\par\par
Функция просмотра медицинских карт пациента. Пользоветелю представляется возможности выбрать карту из перечня (рис. \ref{fig:medcard-list}), после чего программа отображает содержимое выбранной карты, с возможностью перелистывания (рис. \ref{fig:medcard-view}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/medcard-list}
        \caption{Выбор медицинской карты}
        \label{fig:medcard-list}
\end{figure}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/medcard-view}
        \caption{Просмотр содержимого медицинской карты}
        \label{fig:medcard-view}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. SELECT * FROM patient_medcard where regid = ?
2. SELECT count(*) FROM medcard where regid = ?
3. SELECT count(*) FROM medicalcard where card GLOB '*00' || ?
4. SELECT * FROM medicalcard where card GLOB '*00' || ?
\end{lstlisting}
\noindentПервый запрос собирает данные о медицинской карте через обращение к представлению «patient\_medcard» (листинг \ref{list:viewpatientmedcard}). Второй запрос получает количество медицинских карт у пациента. Третий запрос обращается к представлению «medicalcard» для получения количества записей в выбранной медицинской карте. Четвёртый запрос обращается к представлению «medicalcard» (листинг \ref{list:viewmedicalcard} для получения содержимого выбранной медицинской карты.\par\par

Функция смены пароля (рис. \ref{fig:pass-change}). Пользователь должен ввести новый пароль два раза, если оба пароля совпадают, то пользователь уведомляется об успешной смене пароля, в противном случае ему будет предложена новая попытка.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/pass-change}
        \caption{Расписание выбранного врача}
		\label{fig:pass-change}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. UPDATE patient set password = ? where regid = ?
\end{lstlisting}

\subsection{Интерфейс врача}
При входе в систему пользователь попадает в окно поиска (рис. \ref{fig:search}), где можно осуществить поиск пациента, с кем будет продолжена работа.
В поисковое поле можно вводить любую часть имени пациента, и система вернёт все найденные в базе данных совпадения (рис. \ref{fig:search-result}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/search}
        \caption{Окно поиска}
        \label{fig:search}
\end{figure}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/search-result}
        \caption{Результат поиска}
        \label{fig:search-result}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. SELECT regid, fio FROM patient WHERE fio LIKE ?
\end{lstlisting}
\noindentЗапрос возвращает всех пациентов чьи ФИО удовлетворяют критерию отбора по маске.\par
После выбора пациента для работы открывается основной интерфейс, с отображением данных пациента и набором доступных действий (рис. \ref{fig:doctor-interface}).\par\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/doctor-interface}
        \caption{Основной пользовательский интерфейс врача}
        \label{fig:doctor-interface}
\end{figure}

Просмотр карт пациента, аналогичен с тем что был приведен в пользовательском интерфейсе пациента.\par
Функция назначение анализов позволяет врачу назначить какой вид анализов необходимо сдать пациенту (рис. \ref{fig:analysis-create}).
Функция внесения результатов анализов позволяет найти анализы у выбранного пациента которые еще не имеют результатов, и внести результат в базу данных (рис. \ref{fig:analysis-update}). \par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/analysis-create}
        \caption{Назначение анализов}
        \label{fig:analysis-create}
\end{figure}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/analysis-update}
        \caption{Внесение результатов анализов}
        \label{fig:analysis-update}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. INSERT INTO analysis(tabid, cardid, type) values(?, ?, ?)
2. SELECT last_insert_rowid()
3. SELECT anid, type FROM analysis WHERE cardid IN (SELECT cardid FROM
   medcard WHERE regid = ?) AND result IS NULL
4. UPDATE analysis SET result = ? where anid = ?
\end{lstlisting}
\noindentВторой запрос возвращает значение счетчика, который используется в качестве идентификатора анализов, в рамках текещуего соединения. Таким образом можно получить номер анализов который был создан посредством первого запроса.
Третий запрос возвращает все анализы пациента, которые ещё не имеют результата.\par\par

Функция назначения лечения. Позволяет доктору внести в карту пациента диагностированное заболевание и назначенное лечение (рис. \ref{fig:treatment-create}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/treatment}
        \caption{Внесение результатов анализов}
        \label{fig:treatment-create}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. INSERT INTO treatment(tabid, cardid, illness, treatment)
   values(?, ?, ?, ?)
2. SELECT last_insert_rowid()
\end{lstlisting}

Функция выписки рецепта. Пользователю предлагается заполнить перечень лекарств (рис. \ref{fig:receipt-issue}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/receipt-issue}
        \caption{Форма ввода перечня лекарств для рецепта}
        \label{fig:receipt-issue}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. INSERT INTO receipt(tabid, regid, medicine)
   values(?, ?, ?)
\end{lstlisting}

Функция выписки листка нетрудоспособности. Пользователю предлагается выбрать причину нетрудоспособности, а после заполнить форму (рис. \ref{fig:sickleave-issue}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/sickleave-issue}
        \caption{Заполнение формы нетрудоспособности}
        \label{fig:sickleave-issue}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. INSERT INTO sickleave(regid, tabid, stdate, endate, destn, sick_code)
   values(?, ?, ?, ?, ?, ?)
\end{lstlisting}

Функция просмотра листов нетрудоспособности, выданных пациенту. Пользоветелю предоставляется возможности выбрать из списка всех больничных листов, после чего программа отображает форму листа нетрудоспособности (рис. \ref{fig:sickleave-form}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/sickleave-view}
        \caption{Форма листа нетрудоспособности, выданного пациенту}
        \label{fig:sickleave-form}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. SELECT s.sickid, strftime('%d-%m-%Y', s.issuedate),
   strftime('%d-%m-%Y', s.stdate), 
   strftime('%d-%m-%Y', s.endate),
   strftime('%d-%m-%Y',date(s.endate, '+1 day')), 
   s.destn, e.fio, e.position, p.fio, p.gender,
   strftime('%d-%m-%Y',p.birthdate), s.sick_code
   FROM sickleave s \
   JOIN employee e ON s.tabid = e.tabid \
   JOIN patient p ON p.regid = s.regid\
   where s.tabid = ? and s.regid = ?
\end{lstlisting}
\noindentЗапрос возвращает всю необходимую информацию для заполнения формы приведенной на рис. \ref{fig:sickleave-form}.

\subsection{Интерфейс сотрудника регистратуры}
При входе в систему пользователь попадает в основной пользовательский интерфейс сотрудника регистратуры (рис. \ref{fig:registry-interface}).\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/registry-interface}
        \caption{Основной интерфейс сотрудника регистратуры}
        \label{fig:registry-interface}
\end{figure}

Функция просмотра карт пациента аналогична той что реализована в пользовательском интерфейсе пациента, для нахождения конкретного пациента используется поисковое окно (рис. \ref{fig:search}).\par
Функция добавления нового пациента. От пользователя требуется заполнить форму создания нового пациента (рис. \ref{fig:patient-create}), затем программа добавляет нового пациента в систему и возвращает логин и и автоматически сгенерированный пароль.\par
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/patient-create}
        \caption{Форма создания нового пациента}
        \label{fig:patient-create}
\end{figure}
\noindentЗапросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. INSERT INTO patient(fio, insurcomp, icontract, birthdate, gender, address, pnumber)
   VALUES(?, ?, ?, ?, ?, ?, ?)
\end{lstlisting}
\par
Функция изменения данных пациента. От пользователя требуется заполнить форму идентичную той которая использовалась для создания нового пациента, за исключением того, что она уже заполнена текущими данными. Пользоветелю необходимо изменить нужные поля.\par

Функция удаление пациента происходит в несколько этапов:
\begin{enumerate}
	\item В окне поиска (рис. \ref{fig:search}) необходимо найти пользователя для удаления;
	\item При его выборе, программа запросит подтверждение на удаление;
	\item При согласии пользователя система предпринимает попытку удалить пациента из таблицы «Пациент» и перемещения в архив, тем самым приводит в действие триггер «archive\_patient» (листинг \ref{list:trigarchivepatient});
	\item Триггер делает попытку удаления карт пациента и перемещения их в архив, тем самым приводит в действие ещё один триггер «archive\_card» (листинг \ref{list:trigarchivecard});
	\item Триггер «archive\_card» перемещает все данные связанные с удаляемой картой в архив;
	\item Пользоветелю выводится сообщение об успешном перемещении пользователя в архив (рис. \ref{fig:success-archive}).
\end{enumerate}
\begin{figure}[h!]
        \includegraphics[width=\textwidth]{prog_int/success-archive}
        \caption{Уведомление об успешном перемещении пациента в архив}
        \label{fig:success-archive}
\end{figure}
\noindentРезультатом является что пациент перемещен в архив со всеми своими данными.
Запросы, которые отправляются в базу данных следующие: 
\begin{lstlisting}[style=csql] 
1. DELETE FROM patient WHERE regid = ?
\end{lstlisting}
\par
Функции просмотра расписания врачей и создания записи к врачу аналогичны тем что были описаны в интерфейсе пациента.\par
Функция просмотра архива пациентов, работает так же как и функция просмотра карт пациентов, но обращение идёт уже к архиву, а не к основной базе данных.\par

\chapter*{Заключение}
\addcontentsline{toc}{chapter}{Заключение}
Целью данной работы является проектирование базы данных для поликлиники. 
В связи с ростом человеческого населения, и высокой степени бюрократизации поликлиник, проблема
автоматизации работы подобного рода учреждений особенно актуальна, так как это непосредственно
сказывается на качестве оказываемых услуг. В ходе выполнения работы были достигнуты следующие цели: 

\begin{enumerate}[noitemsep]
        \vspace{-5pt}
    \item Была проанализирована предметная область поликлиника и её особенности, также были
        приведены аргументы в пользу необходимости в автоматизации. Были рассмотрены два существующих
        продукта, которые в той или иной мере решают проблему автоматизации, предоставляемые ими
        функции и их специфика. На основании анализа предметной области был выделен перечень
        функций для будущей реализации.
    \item Следующим этапом стало концептуальное проектирование, в ходе которого были выделены
        три действующих лица (врач, сотрудник регистратуры, пациент), для которыx была составлена
        диаграмма вариантов использования, с целью формализации функциональных требований к разрабатываемой системе.
    \item Далее в ходе логического проектирования была создана ER-модель базы данных, где были
        определены основные сущности и их взаимодействия. Для визуализации ER-модели были
        использованы ER-диаграммы. В завершении данного этапа были построена схема БД в виде набора
        схем отношений. А именно следующие десять отношений: Пациент, Сотрудник, Запись, 
		Посещения, Больничный, Лечение, Анализ, График, Медкарта, Рецепт.
    \item Завершающим этапом стало физическое проектирование, в ходе которого в СУБД SQLite была
        создана база данных поликлиники со всеми таблицами, определенных на предыдущем этапе, после
        чего все таблицы были заполнены данными.
\end{enumerate}

\addcontentsline{toc}{chapter}{Список использованных источников}
\bibliography{b}{}

\newpage
\hfill\textbf{Приложение А}
\setcounter{figure}{0}
\counterwithout{figure}{chapter}
\addcontentsline{toc}{chapter}{Приложение А. Примеры заполнение таблиц данными}

\section*{Примеры заполнение таблиц данными}
\setlength{\textfloatsep}{2pt}
\begin{figure}[h!]
        \center\includegraphics[width=\textwidth]{patient}
        \caption{Заполнение таблицы «Пациент»}
        \label{fig:patient}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h!]
        \center\includegraphics[scale=0.83]{employee}
        \caption{Заполнение таблицы «Сотрудник»}
        \label{fig:employee}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h!]
        \center\includegraphics[scale=1]{medcard}
        \caption{Заполнение таблицы «Медкарта»}
        \label{fig:medcard}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h!]
        \center\includegraphics[scale=1]{analysis}
        \caption{Заполнение таблицы «Анализ»}
        \label{fig:analysis}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h!]
        \center\includegraphics[scale=1]{visit}
        \caption{Заполнение таблицы «Посещения»}
        \label{fig:visit}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h]
        \center\includegraphics[scale=1]{ireceipt}
        \caption{Заполнение таблицы «Рецепт»}
        \label{fig:ireceipt}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h]
        \center\includegraphics[scale=1]{itimetable}
        \caption{Заполнение таблицы «График»}
        \label{fig:itimetable}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h]
        \center\includegraphics[scale=1]{sickleave}
        \caption{Заполнение таблицы «Больничный»}
        \label{fig:sickleave}
\end{figure}

\vspace{0.00mm}

\begin{figure}[h]
        \center\includegraphics[scale=1]{appointment}
        \caption{Заполнение таблицы «Запись»}
        \label{fig:appointment}
\end{figure}

\begin{figure}[h!]
        \center\includegraphics[width=\textwidth]{treatment}
        \caption{Заполнение таблицы «Лечение»}
        \label{fig:treatment}
\end{figure}
\vfill
\phantom{0000}

\cleardoublepage
\hfill\textbf{Приложение Б}
\addcontentsline{toc}{chapter}{Приложение Б. Код программы}
\\
В связи с тем что полный код программы составляет более двух тысяч пятисот строк, в данном приложении приведены лишь выдержки из общей кодовой базы.

\section*{Код программы}
\lstinputlisting[title=21. Код интерфейса пациента, label=list:patientint, style=customc]{code/patient.c}
\lstinputlisting[title=22. Код интерфейса врача, label=list:doctorint, style=customc]{code/doctor.c}
\lstinputlisting[title=23. Код интерфейса сотрудника регистратуры, label=list:registryint, style=customc]{code/registry.c}

\end{document}

